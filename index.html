<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Vessel 3D Ship</title>
    </head>
    <body>
        <header>
            <div id="stability-values" style="font-family: sans-serif">
                <h1>Welcome to Vessel 3D Ship</h1>
            </div>
            <div>
                <button id="hull1-btn">Hull 1</button>
                <button id="hull2-btn">Hull 2</button>
            </div>
        </header>

        <script type="module">
            import * as Vessel3D from "./vessel3D.min.js";
            import { loadPyodide } from "https://cdn.jsdelivr.net/pyodide/v0.23.4/full/pyodide.mjs";
            import {
                createHullMeshFromPoints,
                returnHullVessel3DFormation,
            } from "./integrationFunctions.js";

            const hullParams = [
                [
                    10, 0.2762, 0.7011, 0.3642, 0.152, 0.8553, 0.362, 0.321,
                    30.7757, 0.5281, 0.4, 0.42, -1.2, 0.222, 0.8349, -0.3963,
                    0.6785, 2.7622, -2.5205, 50.4096, 1, 1, 0.08, 0.411,
                    0.00024, -1.1797, 1.8982, 10, 0.24, 0.0345, 0.4878, 0, 1,
                    0.00427, 0.8739, 0.4947, 0.1201, 0.2799, 0.6, 0.003, 0.999,
                    0.9929, 0.1, 0, 0.2933,
                ],
                [
                    10, 0.5864, 0.4, 0.135, 0.0766, 0.9998, 0.2058, 0.1177,
                    0.5086, 0.4924, 0.3224, 0.26, -0.8, 0.1, 0.5238, -2.8372,
                    1.9211, 0.2859, 0.088, 7.5462, 0, 1, 0, 0.26, 0.1, 0, 0,
                    6.6703, 0.1226, 0.3971, 0.478, 0, 0, 0.0431, 0.9976, 0.0078,
                    -0.9847, 0.1668, 0.3233, 0.0049, 1, 0.5727, 0.1181, -0.3142,
                    0.0677,
                ],
            ];

            let pyodide = await loadPyodide();
            await pyodide.loadPackage("numpy");

            const pyScript = await fetch(
                "https://raw.githubusercontent.com/ferrari212/vessel3DShipD/refs/heads/main/HullParameterization.py"
            ).then((r) => r.text());
            pyodide.FS.writeFile("HullParameterization.py", pyScript);

            const scene = new Vessel3D.Scene();
            let currentMesh1, currentMesh2;

            function clearOldMeshes() {
                if (currentMesh1) scene.removeFromScene(currentMesh1);
                if (currentMesh2) scene.removeFromScene(currentMesh2);
            }

            async function generateHull(index) {
                clearOldMeshes();

                const params = hullParams[index];

                await pyodide.runPythonAsync(`
                import numpy as np
                from HullParameterization import Hull_Parameterization as HP
                hull = HP(${JSON.stringify(params)})
                points = hull.gen_MeshGridPointCloud(bit_GridOrList=1)
            `);

                const points = pyodide.globals.get("points").toJs();
                const ship = new Vessel3D.Ship();
                const pointsMesh = createHullMeshFromPoints(points);
                const mirrored = pointsMesh.clone();
                mirrored.scale.y = -1;

                const hullFormation = returnHullVessel3DFormation(points);
                ship.addHull(hullFormation);

                // choose the draft as half of the calculated depth of the index
                const draft = params[0] * params[4] * 0.5;

                const hydrostatics = new Vessel3D.HullHydrostatics(
                    hullFormation,
                    draft // draft in meters
                );
                const stability = new Vessel3D.HullStability(ship);

                // Verify stability calculations
                const { heel, trim } = stability.calculateStaticalStability();

                let text = "<h2>Hydrostatics Results</h2>";
                for (const key in hydrostatics) {
                    if (key === "hull") continue;
                    text += `<li><strong>${key}:</strong> ${hydrostatics[
                        key
                    ].toFixed(3)}</li>`;
                }

                document.getElementById("stability-values").innerHTML = text;

                scene.addToScene(pointsMesh);
                scene.addToScene(mirrored);
                currentMesh1 = pointsMesh;
                currentMesh2 = mirrored;
            }

            scene.camera.position.set(10, 5, 5);
            scene.camera.lookAt(0, 0, 0);
            scene.addAxesHelper();

            function animate() {
                requestAnimationFrame(animate);
                scene.renderer.render(scene, scene.camera);
            }

            animate();
            scene.renderer.setSize(
                window.innerWidth * 0.4,
                window.innerHeight * 0.4
            );
            document.body.appendChild(scene.renderer.domElement);

            // Initial hull
            generateHull(0);

            document
                .getElementById("hull1-btn")
                .addEventListener("click", () => {
                    generateHull(0);
                });
            document
                .getElementById("hull2-btn")
                .addEventListener("click", () => {
                    generateHull(1);
                });
        </script>

        <footer>
            <p>
                ShipD, Vessel 3D visualizer and hydrostatics calculations -
                Author: Felipe Ferrari
            </p>
        </footer>
    </body>
</html>
